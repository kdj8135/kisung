{"version":3,"file":"surface.js","sources":["surface.js"],"sourcesContent":["import BaseSurface from '../core/surface';\nimport SurfaceFactory from '../core/surface-factory';\nimport { createPromise, promiseAll, bindEvents, elementSize, unbindEvents } from '../util';\nimport RootNode from './root-node';\nimport ShapesQuadTree from '../search/shapes-quad-tree';\nimport SurfaceCursor from './surface-cursor';\n\nclass Surface extends BaseSurface {\n\n    constructor(element, options) {\n        super(element, options);\n\n        this.element.innerHTML = this._template(this);\n\n        const canvas = this.element.firstElementChild;\n        const size = elementSize(element);\n\n        canvas.width = size.width;\n        canvas.height = size.height;\n\n        this._rootElement = canvas;\n\n        this._root = new RootNode(canvas);\n\n        this._mouseTrackHandler = this._trackMouse.bind(this);\n\n        bindEvents(this.element, {\n            click: this._mouseTrackHandler,\n            mousemove: this._mouseTrackHandler\n        });\n    }\n\n    destroy() {\n        super.destroy();\n\n        if (this._root) {\n            this._root.destroy();\n            this._root = null;\n        }\n\n        if (this._searchTree) {\n            this._searchTree.clear();\n            delete this._searchTree;\n        }\n\n        if (this._cursor) {\n            this._cursor.destroy();\n            delete this._cursor;\n        }\n\n        unbindEvents(this.element, {\n            click: this._mouseTrackHandler,\n            mousemove: this._mouseTrackHandler\n        });\n    }\n\n    draw(element) {\n        super.draw(element);\n        this._root.load([ element ], undefined, this.options.cors);\n\n        if (this._searchTree) {\n            this._searchTree.add([ element ]);\n        }\n    }\n\n    clear() {\n        super.clear();\n        this._root.clear();\n\n        if (this._searchTree) {\n            this._searchTree.clear();\n        }\n\n        if (this._cursor) {\n            this._cursor.clear();\n        }\n    }\n\n    eventTarget(e) {\n        if (this._searchTree) {\n            const point = this._surfacePoint(e);\n            const shape = this._searchTree.pointShape(point);\n            return shape;\n        }\n    }\n\n    image() {\n        const { _root: root, _rootElement: rootElement } = this;\n        const loadingStates = [];\n\n        root.traverse((childNode) => {\n            if (childNode.loading) {\n                loadingStates.push(childNode.loading);\n            }\n        });\n\n        const promise = createPromise();\n        const resolveDataURL = () => {\n            root._invalidate();\n\n            try {\n                const data = rootElement.toDataURL();\n                promise.resolve(data);\n            } catch (e) {\n                promise.reject(e);\n            }\n        };\n\n        promiseAll(loadingStates).then(resolveDataURL, resolveDataURL);\n\n        return promise;\n    }\n\n    suspendTracking() {\n        super.suspendTracking();\n        if (this._searchTree) {\n            this._searchTree.clear();\n            delete this._searchTree;\n        }\n    }\n\n    resumeTracking() {\n        super.resumeTracking();\n        if (!this._searchTree) {\n            this._searchTree = new ShapesQuadTree();\n\n            const childNodes = this._root.childNodes;\n            const rootElements = [];\n            for (let idx = 0; idx < childNodes.length; idx++) {\n                rootElements.push(childNodes[idx].srcElement);\n            }\n            this._searchTree.add(rootElements);\n        }\n    }\n\n    _resize() {\n        this._rootElement.width = this._size.width;\n        this._rootElement.height = this._size.height;\n\n        this._root.invalidate();\n    }\n\n    _template() {\n        return \"<canvas style='width: 100%; height: 100%;'></canvas>\";\n    }\n\n    _enableTracking() {\n        this._searchTree = new ShapesQuadTree();\n        this._cursor = new SurfaceCursor(this);\n\n        super._enableTracking();\n    }\n\n    _trackMouse(e) {\n        if (this._suspendedTracking) {\n            return;\n        }\n\n        const shape = this.eventTarget(e);\n\n        if (e.type !== \"click\") {\n            const currentShape = this._currentShape;\n            if (currentShape && currentShape !== shape) {\n                this.trigger(\"mouseleave\", {\n                    element: currentShape,\n                    originalEvent: e,\n                    type: \"mouseleave\"\n                });\n            }\n\n            if (shape && currentShape !== shape) {\n                this.trigger(\"mouseenter\", {\n                    element: shape,\n                    originalEvent: e,\n                    type: \"mouseenter\"\n                });\n            }\n\n            this.trigger(\"mousemove\", {\n                element: shape,\n                originalEvent: e,\n                type: \"mousemove\"\n            });\n\n            this._currentShape = shape;\n        } else if (shape) {\n            this.trigger(\"click\", {\n                element: shape,\n                originalEvent: e,\n                type: \"click\"\n            });\n        }\n    }\n}\n\nSurface.prototype.type = \"canvas\";\n\nif (typeof document !== \"undefined\" && document.createElement(\"canvas\").getContext) {\n    BaseSurface.support.canvas = true;\n    SurfaceFactory.current.register(\"canvas\", Surface, 20);\n}\n\nexport default Surface;\n"],"names":["super","const","let"],"mappings":"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"}
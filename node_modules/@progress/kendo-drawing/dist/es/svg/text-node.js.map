{"version":3,"file":"text-node.js","sources":["text-node.js"],"sourcesContent":["import PathNode from './path-node';\nimport renderStyle from './utils/render-style';\nimport renderAttr from './utils/render-attribute';\nimport NODE_MAP from './node-map';\nimport { htmlEncode, support } from '../common';\nimport { normalizeText } from '../text-metrics';\n\nconst ENTITY_REGEX = /&(?:[a-zA-Z]+|#\\d+);/g;\n\nfunction decodeEntities(text) {\n    if (!text || typeof text !== \"string\" || !ENTITY_REGEX.test(text)) {\n        return text;\n    }\n\n    const element = decodeEntities._element;\n    ENTITY_REGEX.lastIndex = 0;\n\n    return text.replace(ENTITY_REGEX, (match) => {\n        element.innerHTML = match;\n\n        return element.textContent || element.innerText;\n    });\n}\n\nif (typeof document !== \"undefined\") {\n    decodeEntities._element = document.createElement(\"span\");\n}\n\nclass TextNode extends PathNode {\n\n    geometryChange() {\n        const pos = this.pos();\n        this.attr(\"x\", pos.x);\n        this.attr(\"y\", pos.y);\n        this.invalidate();\n    }\n\n    optionsChange(e) {\n        if (e.field === \"font\") {\n            this.attr(\"style\", renderStyle(this.mapStyle()));\n            this.geometryChange();\n        } else if (e.field === \"content\") {\n            super.content(this.srcElement.content());\n        }\n\n        super.optionsChange(e);\n    }\n\n    mapStyle(encode) {\n        const style = super.mapStyle(encode);\n        let font = this.srcElement.options.font;\n\n        if (encode) {\n            font = htmlEncode(font);\n        }\n\n        style.push([ \"font\", font ], [ \"white-space\", \"pre\" ]);\n\n        return style;\n    }\n\n    pos() {\n        const pos = this.srcElement.position();\n        const size = this.srcElement.measure();\n        return pos.clone().setY(pos.y + size.baseline);\n    }\n\n    renderContent() {\n        let content = this.srcElement.content();\n        content = decodeEntities(content);\n        content = htmlEncode(content);\n\n        return normalizeText(content);\n    }\n\n    renderTextAnchor() {\n        let anchor;\n\n        if ((this.options || {}).rtl && !(support.browser.msie || support.browser.edge)) {\n            anchor = 'end';\n        }\n\n        return renderAttr(\"text-anchor\", anchor);\n    }\n\n    template() {\n        return `<text ${ this.renderId() } ${ this.renderTextAnchor() } ${ this.renderStyle() } ${ this.renderOpacity() }` +\n                    `x='${ this.pos().x }' y='${ this.pos().y }' ${ this.renderStroke() } ${ this.renderTransform() } ${ this.renderDefinitions() }` +\n                    `${ this.renderFill() }>${ this.renderContent() }</text>`;\n    }\n}\n\nNODE_MAP.Text = TextNode;\n\nexport default TextNode;"],"names":["const","super","let"],"mappings":"AAAA,OAAO,QAAQ,MAAM,aAAa,CAAC;AACnC,OAAO,WAAW,MAAM,sBAAsB,CAAC;AAC/C,OAAO,UAAU,MAAM,0BAA0B,CAAC;AAClD,OAAO,QAAQ,MAAM,YAAY,CAAC;AAClC,SAAS,UAAU,EAAE,OAAO,QAAQ,WAAW,CAAC;AAChD,SAAS,aAAa,QAAQ,iBAAiB,CAAC;;AAEhDA,GAAK,CAAC,YAAY,GAAG,uBAAuB,CAAC;;AAE7C,SAAS,cAAc,CAAC,IAAI,EAAE;IAC1B,IAAI,CAAC,IAAI,IAAI,OAAO,IAAI,KAAK,QAAQ,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,EAAE;QAC/D,OAAO,IAAI,CAAC;KACf;;IAEDA,GAAK,CAAC,OAAO,GAAG,cAAc,CAAC,QAAQ,CAAC;IACxC,YAAY,CAAC,SAAS,GAAG,CAAC,CAAC;;IAE3B,OAAO,IAAI,CAAC,OAAO,CAAC,YAAY,EAAE,SAAA,CAAC,KAAK,EAAE,AAAG;QACzC,OAAO,CAAC,SAAS,GAAG,KAAK,CAAC;;QAE1B,OAAO,OAAO,CAAC,WAAW,IAAI,OAAO,CAAC,SAAS,CAAC;KACnD,CAAC,CAAC;CACN;;AAED,IAAI,OAAO,QAAQ,KAAK,WAAW,EAAE;IACjC,cAAc,CAAC,QAAQ,GAAG,QAAQ,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;CAC5D;;AAED,IAAM,QAAQ,GAAiB;IAAC;;;;;;;;IAAA,AAE5B,mBAAA,cAAc,2BAAA,GAAG;QACbA,GAAK,CAAC,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACvB,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;QACtB,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC;QACtB,IAAI,CAAC,UAAU,EAAE,CAAC;KACrB,CAAA;;IAED,mBAAA,aAAa,0BAAA,CAAC,CAAC,EAAE;QACb,IAAI,CAAC,CAAC,KAAK,KAAK,MAAM,EAAE;YACpB,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,WAAW,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC,CAAC,CAAC;YACjD,IAAI,CAAC,cAAc,EAAE,CAAC;SACzB,MAAM,IAAI,CAAC,CAAC,KAAK,KAAK,SAAS,EAAE;YAC9BC,kBAAK,CAAC,OAAO,KAAA,CAAC,MAAA,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC,CAAC;SAC5C;;QAEDA,kBAAK,CAAC,aAAa,KAAA,CAAC,MAAA,CAAC,CAAC,CAAC;KAC1B,CAAA;;IAED,mBAAA,QAAQ,qBAAA,CAAC,MAAM,EAAE;QACbD,GAAK,CAAC,KAAK,GAAGC,kBAAK,CAAC,QAAQ,KAAA,CAAC,MAAA,MAAM,CAAC,CAAC;QACrCC,GAAG,CAAC,IAAI,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC,IAAI,CAAC;;QAExC,IAAI,MAAM,EAAE;YACR,IAAI,GAAG,UAAU,CAAC,IAAI,CAAC,CAAC;SAC3B;;QAED,KAAK,CAAC,IAAI,CAAC,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,EAAE,aAAa,EAAE,KAAK,EAAE,CAAC,CAAC;;QAEvD,OAAO,KAAK,CAAC;KAChB,CAAA;;IAED,mBAAA,GAAG,gBAAA,GAAG;QACFF,GAAK,CAAC,GAAG,GAAG,IAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC;QACvCA,GAAK,CAAC,IAAI,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC;QACvC,OAAO,GAAG,CAAC,KAAK,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,CAAC;KAClD,CAAA;;IAED,mBAAA,aAAa,0BAAA,GAAG;QACZE,GAAG,CAAC,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,CAAC;QACxC,OAAO,GAAG,cAAc,CAAC,OAAO,CAAC,CAAC;QAClC,OAAO,GAAG,UAAU,CAAC,OAAO,CAAC,CAAC;;QAE9B,OAAO,aAAa,CAAC,OAAO,CAAC,CAAC;KACjC,CAAA;;IAED,mBAAA,gBAAgB,6BAAA,GAAG;QACfA,GAAG,CAAC,MAAM,CAAC;;QAEX,IAAI,CAAC,IAAI,CAAC,OAAO,IAAI,EAAE,CAAC,CAAC,GAAG,IAAI,CAAC,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,IAAI,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,EAAE;YAC7E,MAAM,GAAG,KAAK,CAAC;SAClB;;QAED,OAAO,UAAU,CAAC,aAAa,EAAE,MAAM,CAAC,CAAC;KAC5C,CAAA;;IAED,mBAAA,QAAQ,qBAAA,GAAG;QACP,OAAO,QAAO,IAAG,IAAI,CAAC,QAAQ,EAAE,CAAA,MAAG,IAAG,IAAI,CAAC,gBAAgB,EAAE,CAAA,MAAG,IAAG,IAAI,CAAC,WAAW,EAAE,CAAA,MAAG,IAAG,IAAI,CAAC,aAAa,EAAE,CAAA,AAAG;oBACtG,KAAI,IAAG,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC,CAAA,UAAO,IAAG,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC,CAAA,OAAI,IAAG,IAAI,CAAC,YAAY,EAAE,CAAA,MAAG,IAAG,IAAI,CAAC,eAAe,EAAE,CAAA,MAAG,IAAG,IAAI,CAAC,iBAAiB,EAAE,CAAA,AAAG;oBAChI,CAAI,IAAI,CAAC,UAAU,EAAE,CAAA,MAAG,IAAG,IAAI,CAAC,aAAa,EAAE,CAAA,YAAS,AAAC,CAAC;KACzE,CAAA,AACJ;;;EA9DsB,QA8DtB,GAAA;;AAED,QAAQ,CAAC,IAAI,GAAG,QAAQ,CAAC;;AAEzB,eAAe,QAAQ"}